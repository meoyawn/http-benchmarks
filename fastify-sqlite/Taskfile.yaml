version: 3

vars:
  BINARY: dist/server

tasks:
  openapi:
    cmd: bunx @responsibleapi/cli ../http.kdl -o openapi.json
    sources:
      - ../http.kdl
      - Taskfile.yaml
    generates:
      - openapi.json

  start:
    deps:
      - openapi
    cmd: bun src/server.ts --watch

  jbuild:
    deps:
      - openapi
    cmd: bun build --minify src/server.ts --outdir dist/ --packages=external
    sources:
      - src/**/*
      - bun.lockb
      - node_modules/**/*
      - tsconfig.json
      - Taskfile.yaml
    generates:
      - dist/server.js

  jstart:
    deps:
      - jbuild
    cmd: bun dist/server.js

  build:
    deps:
      - openapi
    cmd: bun build --compile --minify src/server.ts --outfile {{.BINARY}}
    sources:
      - src/**/*
      - bun.lockb
      - node_modules/**/*
      - tsconfig.json
      - Taskfile.yaml
    generates:
      - "{{.BINARY}}"

  bstart:
    deps:
      - build
    cmd: ./{{.BINARY}}

  post:
    cmd: >
      oha http://127.0.0.1:3000/notes -z 10s -m POST -T 'application/json' -d '{ "title": "oha benchmark" }'

  get:
    cmd: >
      oha http://127.0.0.1:3000/notes -z 10s
